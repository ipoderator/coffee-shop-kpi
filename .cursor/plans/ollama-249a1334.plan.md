<!-- 249a1334-029f-4a99-bead-9b3f23b464fa 2b47f056-2032-4682-8545-a7bd44c8fdcf -->
# План улучшения качества ML моделей прогнозирования

## Текущая ситуация

- Качество моделей: 15-22% (требует улучшения)
- Средняя ошибка прогноза: 3-4 тысячи рублей
- Ollama: 0 успешных запросов из 7 (критическая проблема)
- Метрики качества основаны на теоретических оценках, а не реальной точности

## Целевые показатели

- Качество моделей: 60-80%
- Средняя ошибка прогноза: 500-1000 рублей (снижение в 3-4 раза)
- Ollama: успешность >80%

## Проблемы и решения

### 1. Интеграция реальных метрик точности из forecastFeedback

**Проблема:** Качество рассчитывается через `evaluateModelPerformance()` на основе теоретических характеристик данных, а не реальной точности прогнозов.

**Решение:**

- Использовать метрики из `forecastFeedback.ts` (MAPE, MAE, RMSE) для расчета качества
- Комбинировать историческую точность (70%) с теоретической оценкой (30%)
- Применять метрики по дням недели для специализированной калибровки

**Файлы:**

- `server/utils/enhancedMLForecasting.ts` - метод `getModelQualityMetrics()`
- `server/utils/forecastFeedback.ts` - интеграция метрик

### 2. Улучшение калибровки прогнозов

**Проблема:** `applyDynamicCalibration()` работает только при отклонении >15%, что недостаточно для точности 3-4 тысячи рублей.

**Решение:**

- Снизить порог калибровки с 15% до 5-7%
- Увеличить силу калибровки с 30% до 50% при больших отклонениях
- Добавить адаптивную калибровку на основе реальных ошибок из БД
- Использовать метрики по дням недели для более точной калибровки

**Файлы:**

- `server/utils/enhancedMLForecasting.ts` - метод `applyDynamicCalibration()`

### 3. Оптимизация ARIMA модели

**Проблема:** Упрощенная реализация ARIMA с фиксированными ограничениями (0.5x - 1.5x от медианы).

**Решение:**

- Улучшить выбор порядка ARIMA через AIC/BIC критерии
- Использовать экспоненциальное сглаживание для инициализации
- Добавить адаптивные ограничения на основе волатильности данных
- Улучшить обработку трендов и сезонности

**Файлы:**

- `server/utils/enhancedMLForecasting.ts` - методы `arimaPredict()`, `selectARIMAOrder()`, `fitAR()`, `fitMA()`

### 4. Улучшение Prophet модели

**Проблема:** Простая модель сезонности без учета сложных паттернов.

**Решение:**

- Добавить мультипликативную сезонность (вместо аддитивной)
- Улучшить обработку праздников и особых событий
- Добавить автоматическое определение сезонных периодов
- Улучшить обработку изменений тренда

**Файлы:**

- `server/utils/enhancedMLForecasting.ts` - метод `prophetPredict()`

### 5. Реальное обучение LSTM/GRU моделей

**Проблема:** LSTM/GRU используют фиксированные веса без реального обучения, что дает низкую точность.

**Решение:**

- Реализовать градиентный спуск для обучения весов
- Добавить мини-батчи и эпохи обучения
- Использовать dropout для регуляризации
- Добавить early stopping для предотвращения переобучения
- Сохранять обученные веса для повторного использования

**Файлы:**

- `server/utils/enhancedMLForecasting.ts` - методы `trainLSTM()`, `trainGRU()`, `predictLSTM()`, `predictGRU()`

### 6. Исправление работы Ollama

**Проблема:** 0 успешных запросов из 7 - критическая проблема.

**Решение:**

- Проверить и исправить обработку ошибок в `callOllama()`
- Улучшить retry логику с экспоненциальным backoff
- Добавить проверку доступности перед запросом
- Улучшить парсинг ответов от Ollama
- Добавить fallback на более простые модели при ошибках

**Файлы:**

- `server/utils/llmForecasting.ts` - метод `callOllama()`, `predictWithLLM()`

### 7. Улучшение ансамбля моделей

**Проблема:** Веса моделей в ансамбле не адаптируются достаточно быстро к изменениям точности.

**Решение:**

- Увеличить влияние реальной точности с 55% до 70% в `adaptiveEnsemble()`
- Добавить экспоненциальное затухание для старых метрик точности
- Улучшить специализацию по дням недели (увеличить вес с 60% до 75%)
- Добавить динамическое перераспределение весов при низкой точности модели

**Файлы:**

- `server/utils/enhancedMLForecasting.ts` - метод `adaptiveEnsemble()`

### 8. Автоматическая калибровка на основе реальных данных

**Проблема:** Нет автоматической калибровки на основе сравнения прогнозов с реальными данными.

**Решение:**

- Создать систему автоматической калибровки при получении реальных данных
- Рассчитывать систематическую ошибку для каждой модели
- Применять корректирующие коэффициенты к будущим прогнозам
- Сохранять коэффициенты калибровки в БД для повторного использования

**Файлы:**

- `server/utils/forecastFeedback.ts` - добавить метод `calculateCalibrationFactors()`
- `server/utils/enhancedMLForecasting.ts` - интеграция калибровочных коэффициентов

### 9. Улучшение обработки внешних факторов

**Проблема:** Внешние факторы (погода, праздники) могут использоваться неэффективно.

**Решение:**

- Добавить веса для внешних факторов на основе корреляционного анализа
- Улучшить обработку праздников с учетом типа праздника
- Добавить адаптивные веса для погодных факторов
- Улучшить обработку экономических показателей

**Файлы:**

- `server/utils/enhancedMLForecasting.ts` - методы расчета влияния внешних факторов

### 10. Мониторинг и диагностика качества

**Проблема:** Нет детального мониторинга качества моделей в реальном времени.

**Решение:**

- Добавить endpoint для получения детальных метрик качества
- Создать дашборд с историей качества моделей
- Добавить алерты при падении качества ниже порога
- Сохранять метрики качества в БД для анализа трендов

**Файлы:**

- `server/routes/analytics.ts` - новый endpoint `/api/analytics/model-quality`
- `server/utils/enhancedMLForecasting.ts` - метод для детальных метрик

## Приоритеты реализации

### Высокий приоритет (критично для улучшения качества):

1. Интеграция реальных метрик точности из forecastFeedback
2. Улучшение калибровки прогнозов (снижение порога до 5-7%)
3. Исправление работы Ollama (0 успешных запросов)
4. Автоматическая калибровка на основе реальных данных

### Средний приоритет (значительное улучшение):

5. Реальное обучение LSTM/GRU моделей
6. Улучшение ансамбля моделей (увеличение веса реальной точности)
7. Оптимизация ARIMA модели

### Низкий приоритет (дополнительные улучшения):

8. Улучшение Prophet модели
9. Улучшение обработки внешних факторов
10. Мониторинг и диагностика качества

## Ожидаемые результаты

После реализации плана:

- Качество моделей: 60-80% (улучшение в 3-4 раза)
- Средняя ошибка прогноза: 500-1000 рублей (снижение в 3-4 раза)
- Ollama успешность: >80%
- Более стабильные и точные прогнозы
- Автоматическая адаптация к изменениям в данных

### To-dos

- [ ] Включить автоматический запуск Ollama при старте сервера (неблокирующий) в server/index.ts
- [ ] Сделать LLM-анализ асинхронным в server/routes/analytics.ts и server/utils/analytics.ts
- [ ] Оптимизировать таймауты и проверку статуса в server/utils/ollamaManager.ts
- [ ] Увеличить таймаут для LLM запросов в server/utils/llmForecasting.ts
- [ ] Добавить endpoint для проверки статуса LLM-анализа в server/routes/analytics.ts
- [ ] Улучшить кеширование с поддержкой LLM-статуса в server/utils/analyticsCache.ts