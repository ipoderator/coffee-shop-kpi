<!-- f4c741b7-d436-4f75-bd34-323002f2838d 79032550-e6d4-4c17-9d49-9c531f89b794 -->
# План улучшения ML прогнозов и анализа отклонений

## Цели

1. Улучшить точность прогнозов всех ML моделей
2. Автоматически учитывать реальные данные (например, за ноябрь) для анализа отклонений
3. Понимать причины ошибок прогнозирования
4. Автоматически рекалибровать модели на основе реальных данных

## Текущее состояние

- Есть система `forecastFeedback.ts` для сохранения прогнозов и метрик
- Есть функции расчета метрик (MAPE, MAE, RMSE)
- Есть калибровка уверенности на основе исторической точности
- НО: прогнозы не сохраняются автоматически при генерации
- НО: нет автоматического сопоставления реальных данных с прогнозами
- НО: нет анализа причин отклонений
- НО: нет автоматической рекалибровки моделей

## Задачи

### 1. Автоматическое сохранение прогнозов

**Файлы:** `server/utils/analytics.ts`, `server/utils/enhancedMLForecasting.ts`

- Интегрировать `saveForecastPrediction` в процесс генерации прогнозов
- Сохранять прогнозы всех моделей (ARIMA, Prophet, LSTM, GRU, Linear, Moving Average) при генерации
- Сохранять метаданные: дата прогноза, горизонт, уверенность, модель

### 2. Автоматическое сопоставление реальных данных с прогнозами

**Файлы:** `server/routes/upload.ts`, `server/utils/forecastFeedback.ts`

- При загрузке новых данных автоматически находить соответствующие прогнозы
- Сопоставлять по дате и uploadId
- Обновлять прогнозы реальными данными и рассчитывать метрики ошибок
- Вызывать `processFeedbackLoop` при загрузке данных

### 3. Анализ причин отклонений

**Файлы:** `server/utils/forecastErrorAnalysis.ts` (новый)

- Анализировать паттерны ошибок по дням недели
- Анализировать влияние сезонности на ошибки
- Анализировать влияние внешних факторов (погода, праздники)
- Определять систематические ошибки моделей (завышение/занижение)
- Группировать ошибки по типам (выходные дни, праздники, начало/конец месяца)

### 4. Улучшение алгоритмов обучения моделей

**Файлы:** `server/utils/enhancedMLForecasting.ts`

- Использовать реальные метрики для адаптации весов моделей в ансамбле
- Применять коэффициенты калибровки из `calculateCalibrationFactors` к прогнозам
- Улучшить расчет исторической точности с учетом реальных данных
- Добавить экспоненциальное сглаживание для адаптации весов

### 5. Визуализация ошибок и анализ отклонений

**Файлы:** `client/src/components/ForecastErrorAnalysis.tsx` (новый), `server/routes/analytics.ts`

- Компонент для отображения анализа ошибок прогнозирования
- Графики отклонений по дням недели
- Графики отклонений по моделям
- Таблица с детальным анализом каждого отклонения
- Рекомендации по улучшению на основе анализа

### 6. Автоматическая рекалибровка моделей

**Файлы:** `server/utils/enhancedMLForecasting.ts`, `server/utils/modelRecalibration.ts` (новый)

- Автоматически переобучать модели при накоплении достаточного количества реальных данных
- Применять коэффициенты калибровки к прогнозам
- Адаптировать параметры моделей на основе ошибок
- Обновлять веса ансамбля на основе реальной производительности

### 7. API для анализа ошибок

**Файлы:** `server/routes/analytics.ts`

- `GET /api/analytics/:uploadId/forecast-errors` - получить анализ ошибок прогнозирования
- `GET /api/analytics/:uploadId/model-performance` - получить производительность моделей
- `POST /api/analytics/:uploadId/recalibrate` - запустить рекалибровку моделей

### 8. Интеграция в существующий UI

**Файлы:** `client/src/pages/AnalyticsPage.tsx`, `client/src/components/EnhancedWeeklyForecastCard.tsx`

- Добавить вкладку "Анализ ошибок" в карточку прогноза
- Показывать метрики точности моделей
- Показывать рекомендации по улучшению
- Визуализировать отклонения прогнозов от реальных данных

## Технические детали

### Структура данных для анализа ошибок

```typescript
interface ForecastErrorAnalysis {
  modelName: string;
  totalPredictions: number;
  predictionsWithActual: number;
  averageMape: number;
  averageMae: number;
  averageRmse: number;
  errorsByDayOfWeek: Record<number, ErrorStats>;
  errorsByHorizon: Record<number, ErrorStats>;
  systematicBias: number; // >0 завышение, <0 занижение
  calibrationFactor: number;
  recommendations: string[];
}
```

### Процесс автоматического сопоставления

1. При загрузке данных извлекать даты и выручку
2. Найти все прогнозы для этих дат и uploadId
3. Обновить прогнозы реальными данными
4. Рассчитать метрики ошибок
5. Обновить метрики моделей
6. Запустить анализ причин отклонений

### Улучшение весов ансамбля

- Использовать реальные метрики вместо теоретических оценок
- Применять экспоненциальное сглаживание для адаптации весов
- Учитывать недавние ошибки больше, чем старые
- Минимизировать общую ошибку ансамбля

## Приоритеты

1. Высокий: Автоматическое сохранение и сопоставление прогнозов
2. Высокий: Анализ причин отклонений
3. Средний: Улучшение алгоритмов обучения
4. Средний: Визуализация ошибок
5. Низкий: Автоматическая рекалибровка (можно запускать вручную)

### To-dos

- [ ] Интегрировать автоматическое сохранение прогнозов при генерации в enhancedMLForecasting.ts
- [ ] Добавить автоматическое сопоставление реальных данных с прогнозами при загрузке данных в upload.ts
- [ ] Создать модуль forecastErrorAnalysis.ts для анализа причин отклонений (дни недели, сезонность, внешние факторы)
- [ ] Улучшить алгоритмы обучения: использовать реальные метрики для весов ансамбля, применять калибровку
- [ ] Создать компонент ForecastErrorAnalysis.tsx для визуализации ошибок и анализа отклонений
- [ ] Добавить API endpoints для получения анализа ошибок и производительности моделей
- [ ] Реализовать автоматическую рекалибровку моделей на основе накопленных ошибок
- [ ] Интегрировать анализ ошибок в UI: добавить вкладку в EnhancedWeeklyForecastCard, показать метрики