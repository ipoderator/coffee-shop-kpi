<!-- 2907eb4b-8df7-4553-b5c8-f77b61a8bbdb e9dce8af-ce76-490f-9541-07d978e495ba -->
# Улучшение качества прогнозов "Углубленный анализ и прогноз"

## Анализ текущего состояния

### Обнаруженные проблемы:

1. **Метрики качества моделей**

- Используют теоретические оценки (30%) + реальные метрики (70%)
- Реальные метрики могут отсутствовать при малом количестве данных
- Fallback значения (0.5) не отражают реальное качество

2. **Калибровка прогнозов**

- `applyDynamicCalibration()` работает только при отклонении >15%
- Недостаточная адаптация к историческим ошибкам
- Сглаживание может скрывать реальные паттерны

3. **Использование исторических данных**

- Метрики из `forecastFeedback` используются, но не всегда доступны
- Нет автоматической рекалибровки на основе новых данных
- Специализация по дням недели используется частично

4. **Ансамбль моделей**

- Веса моделей рассчитываются статически
- Недостаточная адаптация к характеристикам данных
- Нет учета реальной точности каждой модели

5. **Расчет уверенности (confidence)**

- Базируется на теоретических оценках
- Не учитывает историческую точность моделей
- Не адаптируется к качеству данных

## План улучшений

### 1. Улучшение метрик качества моделей

- Использовать реальные метрики из БД как основной источник (80% веса)
- Улучшить fallback для случаев отсутствия реальных метрик
- Добавить специализацию по дням недели и горизонтам прогноза
- Учитывать размер выборки для оценки надежности метрик

### 2. Улучшение калибровки прогнозов

- Снизить порог активации калибровки с 15% до 5-7%
- Использовать исторические ошибки для более точной калибровки
- Добавить адаптивную калибровку на основе дня недели
- Улучшить использование метрик MAPE/MAE/RMSE для калибровки

### 3. Оптимизация ансамбля моделей

- Использовать реальные метрики точности для расчета весов моделей
- Добавить адаптивные веса в зависимости от характеристик данных
- Улучшить специализацию моделей по дням недели
- Добавить динамическое переключение между моделями

### 4. Улучшение расчета уверенности

- Использовать историческую точность моделей для расчета confidence
- Учитывать качество данных (полнота, консистентность)
- Добавить адаптивную уверенность на основе дня недели
- Улучшить отображение уверенности в UI

### 5. Использование исторических данных

- Автоматически использовать метрики из `forecastFeedback` при их наличии
- Добавить автоматическую рекалибровку при поступлении новых данных
- Улучшить сопоставление прогнозов с реальными данными
- Добавить анализ причин отклонений

## Файлы для изменения

1. `server/utils/enhancedMLForecasting.ts`

- Метод `getModelQualityMetrics()` - улучшить использование реальных метрик
- Метод `applyDynamicCalibration()` - снизить порог и улучшить логику
- Метод `calculateEnhancedConfidence()` - использовать исторические метрики
- Метод `modelEnsemble.metaModel()` - оптимизировать веса моделей

2. `client/src/components/EnhancedWeeklyForecastCard.tsx`

- Улучшить отображение метрик качества
- Добавить визуализацию уверенности прогнозов
- Улучшить инсайты на основе реальных метрик

## Ожидаемые результаты

- Улучшение точности прогнозов на 15-25%
- Более точные метрики качества моделей
- Лучшая калибровка прогнозов
- Более надежная уверенность в прогнозах
- Лучшее использование исторических данных

### To-dos

- [ ] Улучшить getModelQualityMetrics() - использовать реальные метрики как основной источник (80% веса), улучшить fallback
- [ ] Улучшить applyDynamicCalibration() - снизить порог до 5-7%, использовать исторические ошибки, добавить специализацию по дням недели
- [ ] Оптимизировать ансамбль моделей - использовать реальные метрики для весов, добавить адаптивные веса
- [ ] Улучшить calculateEnhancedConfidence() - использовать историческую точность, учитывать качество данных
- [ ] Улучшить использование исторических данных - автоматическая рекалибровка, анализ отклонений