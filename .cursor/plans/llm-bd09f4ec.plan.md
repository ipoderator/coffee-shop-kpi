<!-- bd09f4ec-01b5-43d8-9276-940145dfcb4b ca5cedbe-f480-4bfb-bfe0-02f5ebcc16e1 -->
# Улучшение точности прогнозирования при малом объеме данных

# Анализ текущих проблем

### Обнаруженные ограничения:

1. **Минимальные пороги данных:**

   - Fallback при <7 дней (простое среднее)
   - LLM требует >=14 дней
   - Кросс-валидация требует >=14 дней
   - Специализация по дням недели требует >=21 день

2. **Потеря точности при малых данных:**

   - Невозможно оценить сезонность
   - Нет достаточной статистики для точной калибровки
   - Модели переобучаются или недообучаются
   - Недостаточно данных для адаптивных весов

3. **Неиспользуемые возможности:**

   - Байесовские методы есть в `analytics.ts`, но не интегрированы в `EnhancedMLForecastingEngine`
   - Бутстрап-сэмплинг не используется для augmentation
   - Экспертные знания используются минимально

## Предлагаемые улучшения

### 1. Интеграция байесовских методов для малых данных

**Проблема:** Байесовские методы эффективны при малом объеме данных, но не используются в основном движке.

**Решение:**

- Добавить байесовскую модель в ансамбль `EnhancedMLForecastingEngine`
- Использовать априорные распределения на основе экспертных знаний
- Применять байесовское обновление для объединения малого количества наблюдений с априорными знаниями
- Увеличить вес байесовской модели при <30 дней данных

**Файлы:**

- `server/utils/enhancedMLForecasting.ts` - добавить метод `bayesianPredict()`
- Интегрировать в `initializeModelEnsemble()` с весом 0.25-0.35 для малых данных

### 2. Data Augmentation через бутстрап-сэмплинг

**Проблема:** При малом объеме данных невозможно эффективно оценить неопределенность.

**Решение:**

- Использовать бутстрап-сэмплинг для генерации синтетических данных
- Создавать расширенные выборки для обучения моделей
- Применять к моделям, требующим больше данных (RandomForest, XGBoost)
- Использовать для оценки доверительных интервалов

**Файлы:**

- `server/utils/enhancedMLForecasting.ts` - добавить метод `augmentDataWithBootstrap()`
- Применять augmentation перед обучением моделей при <30 дней

### 3. Улучшенная калибровка на основе экспертных знаний

**Проблема:** При малом объеме данных стандартная калибровка неэффективна.

**Решение:**

- Использовать экспертные знания о типичных паттернах кофеен:
  - Средняя выручка в день недели (понедельник обычно ниже, пятница выше)
  - Сезонные паттерны (лето выше, зима ниже)
  - Влияние праздников (повышение на 20-30%)
- Создать библиотеку экспертных правил
- Применять калибровку на основе экспертных знаний при <14 дней данных

**Файлы:**

- `server/utils/expertKnowledge.ts` (новый) - экспертные правила
- `server/utils/enhancedMLForecasting.ts` - интеграция экспертных правил

### 4. Адаптивное использование LLM для малых данных

**Проблема:** LLM требует >=14 дней, хотя может работать с меньшим количеством при правильном промпте.

**Решение:**

- Создать специальные промпты для малых данных (<14 дней)
- Использовать few-shot learning с примерами из похожих кофеен
- Применять экспертные знания в промптах для компенсации недостатка данных
- Увеличить вес LLM при малых данных (0.2-0.3 вместо 0.15)

**Файлы:**

- `server/utils/llmForecasting.ts` - метод `buildSmallDataPrompt()`
- Адаптация веса LLM в `calculateLLMWeight()`

### 5. Упрощение моделей для малых данных

**Проблема:** Сложные модели (RandomForest, XGBoost) переобучаются при малых данных.

**Решение:**

- Автоматически упрощать модели при <30 дней:
  - Уменьшать количество деревьев в RandomForest (с 100 до 20-30)
  - Уменьшать глубину деревьев
  - Использовать более сильную регуляризацию
- Отключать сложные модели при <7 дней
- Увеличивать вес простых моделей (ARIMA, Prophet) при малых данных

**Файлы:**

- `server/utils/enhancedMLForecasting.ts` - методы `simplifyModelForSmallData()`
- Адаптация параметров моделей в зависимости от объема данных

### 6. Улучшенное агрегирование прогнозов

**Проблема:** При малых данных стандартное взвешенное среднее может быть неоптимальным.

**Решение:**

- Использовать медиану вместо среднего для малых данных (более робастно)
- Применять trimmed mean (удаление выбросов)
- Использовать консенсус моделей (большинство голосов)
- Учитывать согласованность прогнозов между моделями

**Файлы:**

- `server/utils/enhancedMLForecasting.ts` - улучшить `adaptiveEnsemble()` для малых данных

### 7. Использование внешних данных для компенсации

**Проблема:** Внешние данные (погода, праздники) используются, но не агрессивно при малых данных.

**Решение:**

- Увеличить влияние внешних факторов при малых данных
- Использовать данные из похожих кофеен (если доступны)
- Применять региональные паттерны продаж
- Использовать данные о днях недели из других источников

**Файлы:**

- `server/utils/enhancedMLForecasting.ts` - увеличить веса внешних факторов при <30 дней

### 8. Метрики качества для малых данных

**Проблема:** Текущие метрики (MAPE, MAE, RMSE) не адаптированы для малых данных.

**Решение:**

- Использовать относительные метрики (MAPE более важен при малых данных)
- Добавить метрики согласованности моделей
- Использовать метрики на основе доверительных интервалов
- Отслеживать улучшение точности по мере накопления данных

**Файлы:**

- `server/utils/enhancedMLForecasting.ts` - улучшить `calculateHistoricalModelAccuracy()` для малых данных

## Ожидаемые результаты

1. **Улучшение точности на 20-40%** для данных <30 дней
2. **Снижение ошибки с 5000 руб до 2000-3000 руб** при малых данных
3. **Более стабильные прогнозы** за счет использования экспертных знаний
4. **Лучшая работа с 7-14 днями данных** вместо простого fallback

## Приоритеты реализации

1. **Высокий приоритет:**

   - Интеграция байесовских методов
   - Улучшенная калибровка на основе экспертных знаний
   - Адаптивное использование LLM для малых данных

2. **Средний приоритет:**

   - Data augmentation через бутстрап
   - Упрощение моделей для малых данных
   - Улучшенное агрегирование

3. **Низкий приоритет:**

   - Использование внешних данных
   - Метрики качества

## Технические детали

### Байесовская модель:

```typescript
- Использовать нормальное априорное распределение
- Априорное среднее: экспертная оценка на основе дня недели
- Априорная дисперсия: 30% от среднего
- Обновление через байесовский вывод
```

### Экспертные знания:

```typescript
- Дни недели: Пн-Чт (0.9x), Пт-Вс (1.1x)
- Праздники: +20-30% к выручке
- Сезонность: Лето (+5%), Зима (-10%)
- Время месяца: Начало (-5%), Конец (+10%)
```

### Data Augmentation:

```typescript
- Бутстрап 500-1000 сэмплов
- Применять только к моделям, требующим >10 дней
- Использовать для оценки неопределенности
```

### To-dos

- [x] Создать модуль llmForecasting.ts с классом LLMForecastingEngine для работы с OpenAI API
- [x] Добавить конфигурацию OpenAI API в env.example и обработку переменных окружения
- [x] Реализовать подготовку промптов с историческими данными, статистикой и внешними факторами
- [x] Интегрировать LLM модель в ансамбль EnhancedMLForecastingEngine
- [x] Реализовать расчет адаптивных весов для LLM на основе исторической точности
- [x] Добавить кеширование запросов LLM для одинаковых контекстов
- [x] Реализовать обработку ошибок, retry логику и fallback на существующие модели
- [x] Добавить логирование и метрики для мониторинга использования LLM и точности