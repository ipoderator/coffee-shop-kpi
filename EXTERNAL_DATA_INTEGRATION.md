# Интеграция внешних источников данных для повышения точности прогнозирования

## Обзор

Система прогнозирования кофейной KPI дашборды была расширена интеграцией с внешними источниками данных для повышения точности прогнозов выручки. Это включает в себя данные о погоде, экономических индикаторах, праздниках, трафике и настроениях в социальных сетях.

## Интегрированные источники данных

### 1. Погодные данные (OpenWeatherMap API)

**API**: OpenWeatherMap  
**Бесплатный тариф**: 1000 запросов/день  
**Данные**:

- Температура воздуха
- Осадки (дождь, снег)
- Влажность
- Скорость ветра
- Облачность
- УФ-индекс
- Видимость

**Влияние на прогноз**:

- Комфортная температура (15-25°C): +10% к выручке
- Экстремальные температуры: -10% до -20%
- Дождь: -5% до -20% в зависимости от интенсивности
- Сильный ветер: -5% до -10%
- Туман: -15%

### 2. Экономические индикаторы (ExchangeRate-API.com)

**API**: ExchangeRate-API.com  
**Бесплатный тариф**: 1500 запросов/месяц  
**Данные**:

- Курс валют (USD/RUB)
- Инфляция
- Потребительское доверие
- Уровень безработицы
- Рост ВВП
- Процентные ставки

**Влияние на прогноз**:

- Высокая инфляция (>8%): -10% к выручке
- Низкая инфляция (<2%): +3%
- Высокое потребительское доверие: +5%
- Высокая безработица (>8%): -10%

### 3. Календарь праздников (Calendarific API)

**API**: Calendarific  
**Бесплатный тариф**: 1000 запросов/месяц  
**Данные**:

- Государственные праздники
- Религиозные праздники
- Региональные праздники
- Неофициальные праздники

**Влияние на прогноз**:

- Новый год и Рождество: +30%
- День Победы, 23 февраля: +25%
- Международный женский день: +20%
- Обычные государственные праздники: +15%
- Религиозные праздники: +10-15%

### 4. Данные о трафике (Google Maps API)

**API**: Google Maps Distance Matrix API  
**Требует**: Биллинг аккаунт  
**Данные**:

- Уровень загруженности дорог
- Средняя скорость движения
- Объем трафика
- Дорожные условия

**Влияние на прогноз**:

- Высокая загруженность (>80%): -10%
- Низкая загруженность (<30%): +3%
- Медленное движение (<20 км/ч): -8%

### 5. Анализ настроений в соцсетях

**Источники**: NewsAPI, Twitter API (опционально)  
**Данные**:

- Тональность упоминаний о кофе/кофейнях
- Объем упоминаний
- Платформы (новости, Twitter, Instagram)
- Ключевые слова

**Влияние на прогноз**:

- Положительные настроения: +2% до +20%
- Отрицательные настроения: -2% до -20%
- Высокий объем упоминаний увеличивает влияние

## Алгоритм прогнозирования

### Расширенный многофакторный ансамбль с машинным обучением

Система использует комбинацию из 7 продвинутых методов прогнозирования с адаптивными весами:

1. **Улучшенная многомерная линейная регрессия с L2 регуляризацией** (15% веса)
   - Предотвращение переобучения
   - Оптимизированные коэффициенты на исторических данных
   - Учет всех внешних факторов

2. **Тройное экспоненциальное сглаживание (Holt-Winters)** (15% веса)
   - Учет уровня, тренда и сезонности
   - Адаптивные параметры сглаживания
   - Эффективно для трендовых и сезонных данных

3. **Адаптивное скользящее среднее с динамическими окнами** (15% веса)
   - Автоматический выбор размера окна на основе волатильности
   - Экспоненциальные веса для недавних данных
   - Устойчивость к выбросам

4. **Глубокая нейронная сеть с множественными слоями** (20% веса)
   - 13 входных нейронов → 8 скрытых → 5 скрытых → 1 выходной
   - Функция активации tanh для скрытых слоев
   - Нормализация и денормализация данных

5. **SARIMA (Seasonal ARIMA) анализ временных рядов** (15% веса)
   - Автоматическое определение порядка AR/MA
   - Сезонные компоненты с лагом 12
   - Учет автокорреляции и сезонности

6. **Градиентный бустинг с ансамблем деревьев решений** (15% веса)
   - 5 специализированных деревьев для разных факторов
   - Адаптивные веса для каждого дерева
   - Высокая точность на сложных зависимостях

7. **Поддержка векторных машин (SVM) с радиальным ядром** (5% веса)
   - Опорные векторы для классификации паттернов
   - RBF ядро для нелинейных зависимостей
   - Эффективен для малых выборок

### Адаптивные веса и динамическое обучение

Система автоматически адаптирует веса методов на основе характеристик данных:

**Адаптация весов:**

- **Высокая волатильность** → больше веса стабильным методам (скользящее среднее, линейная регрессия)
- **Сильный тренд** → больше веса методам трендового анализа (экспоненциальное сглаживание, SARIMA)
- **Сильная сезонность** → больше веса сезонным методам (SARIMA, экспоненциальное сглаживание)

**Постобработка прогнозов:**

- Проверка на выбросы (3σ правило)
- Сглаживание экстремальных значений
- Ограничения на основе дня недели
- Финальная сезонная корректировка

### Уровень уверенности

Система рассчитывает уровень уверенности в прогнозе на основе:

- **Количество исторических данных** (35% веса)
- **Стабильность данных** (25% веса)
- **Сезонность дня недели** (20% веса)
- **Объем данных** (10% веса)
- **Качество данных** (10% веса)
- **Бонус за внешние данные** (до +15%)
- **Качество ансамбля методов** (до +10%)

## Настройка и конфигурация

### 1. Получение API ключей

#### OpenWeatherMap

1. Зарегистрируйтесь на [openweathermap.org](https://openweathermap.org)
2. Получите бесплатный API ключ
3. Добавьте в `.env`: `OPENWEATHER_API_KEY=your_key`

#### ExchangeRate-API

1. Зарегистрируйтесь на [exchangerate-api.com](https://exchangerate-api.com)
2. Получите бесплатный API ключ
3. Добавьте в `.env`: `EXCHANGERATE_API_KEY=your_key`

#### Calendarific

1. Зарегистрируйтесь на [calendarific.com](https://calendarific.com)
2. Получите бесплатный API ключ
3. Добавьте в `.env`: `CALENDARIFIC_API_KEY=your_key`

#### Google Maps (опционально)

1. Создайте проект в [Google Cloud Console](https://console.cloud.google.com)
2. Включите Distance Matrix API
3. Создайте API ключ с ограничениями
4. Добавьте в `.env`: `GOOGLE_MAPS_API_KEY=your_key`

### 2. Настройка местоположения

```env
DEFAULT_LATITUDE=55.7558
DEFAULT_LONGITUDE=37.6176
DEFAULT_LOCATION_NAME=Moscow
```

### 3. Настройка кэширования

```env
CACHE_TTL_WEATHER=1800      # 30 минут
CACHE_TTL_ECONOMIC=3600     # 1 час
CACHE_TTL_HOLIDAYS=86400    # 24 часа
CACHE_TTL_TRAFFIC=900       # 15 минут
```

## Использование

### Автоматическое использование

Система автоматически использует внешние данные при генерации прогнозов:

```typescript
const analytics = await calculateAnalytics(transactions);
// Включает улучшенный прогноз с внешними данными
```

### Fallback механизм

Если внешние API недоступны, система автоматически переключается на базовый алгоритм прогнозирования с сохранением функциональности.

## Мониторинг и отладка

### Логирование

Система логирует:

- Успешные запросы к внешним API
- Ошибки API с деталями
- Переключения на fallback режим
- Использование кэшированных данных

### Метрики качества

Система отслеживает:

- Точность прогнозов (MAPE - Mean Absolute Percentage Error)
- Время отклика API
- Доступность внешних сервисов
- Использование кэша

## Ограничения и рекомендации

### Лимиты API

- **OpenWeatherMap**: 1000 запросов/день
- **ExchangeRate-API**: 1500 запросов/месяц
- **Calendarific**: 1000 запросов/месяц
- **Google Maps**: Требует биллинг

### Рекомендации

1. **Мониторинг лимитов**: Отслеживайте использование API
2. **Кэширование**: Настройте агрессивное кэширование
3. **Fallback**: Всегда имейте резервный план
4. **Тестирование**: Регулярно проверяйте точность прогнозов

## Точность прогнозирования

### Ожидаемая точность

- **С внешними данными**: 80-90%
- **Без внешних данных**: 60-75%
- **При недостатке исторических данных**: 50-70%

### Факторы, влияющие на точность

1. **Объем исторических данных**: >3 месяцев для хорошей точности
2. **Стабильность бизнеса**: Регулярные паттерны повышают точность
3. **Качество внешних данных**: Актуальные данные важны
4. **Сезонность**: Учет сезонных колебаний

## Будущие улучшения

### Планируемые интеграции

1. **Демографические данные**: Население, возрастные группы, доходы
2. **События и мероприятия**: Концерты, фестивали, выставки
3. **Конкурентный анализ**: Данные о конкурентах
4. **Мобильные данные**: Анонимизированные данные о мобильности

### Улучшения алгоритма

1. **Машинное обучение**: Более сложные ML модели
2. **Реальное время**: Обновление прогнозов в реальном времени
3. **Персонализация**: Адаптация под специфику бизнеса
4. **A/B тестирование**: Сравнение различных подходов

## Поддержка

При возникновении проблем:

1. Проверьте логи приложения
2. Убедитесь в корректности API ключей
3. Проверьте доступность внешних сервисов
4. Обратитесь к документации API провайдеров

## Лицензии и условия использования

Убедитесь, что соблюдаете условия использования всех интегрированных API:

- [OpenWeatherMap Terms](https://openweathermap.org/terms)
- [ExchangeRate-API Terms](https://exchangerate-api.com/terms)
- [Calendarific Terms](https://calendarific.com/terms)
- [Google Maps Terms](https://cloud.google.com/maps-platform/terms)
